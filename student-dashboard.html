import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, collection, addDoc, doc, deleteDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { getStorage, ref as storageRef, uploadBytesResumable, deleteObject, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

// --- Global Setup ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

let db, auth, storage;

// Function to initialize Firebase and authenticate
async function initializeFirebase() {
    try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        storage = getStorage(app);

        // Sign in using the provided token or anonymously
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }
        console.log("Firebase initialized and signed in.");

        // Once authenticated, load posts
        loadPastPosts();

    } catch (error) {
        console.error("Error during Firebase initialization or sign-in:", error);
        displayStatus("Error initializing Firebase. Check console for details.", 'error');
    }
}

// --- Helper Functions ---
function displayStatus(message, type) {
    const statusDiv = document.getElementById("upload-status");
    statusDiv.style.display = "block";
    statusDiv.className = `status-message ${type}`;
    statusDiv.textContent = message;
}

// FIRESTORE SAVE FUNCTION (Runs after file upload)
async function saveToFirestore(title, type, description, fileURL, fileName) {
    const uploadBtn = document.getElementById("upload-btn");
    const userId = auth.currentUser?.uid || 'anonymous';
    
    // Public Collection Path for shared announcements
    const collectionPath = `artifacts/${appId}/public/data/teacher_announcements`;

    try {
        await addDoc(collection(db, collectionPath), {
            title,
            type,
            description,
            fileURL: fileURL || null, // Stores the public download URL
            fileName: fileName || null, // Stores the unique name for deletion
            date: new Date().toLocaleDateString("en-IN"),
            timestamp: serverTimestamp(),
            authorId: userId,
        });

        displayStatus("Announcement Posted Successfully!", 'success');
        document.getElementById("upload-form").reset();

    } catch (error) {
        console.error("Error writing document to Firestore: ", error);
        displayStatus(`Error posting announcement: ${error.message}`, 'error');
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = "Post to Student Portal";
    }
}


// STORAGE UPLOAD HANDLER
async function handleUpload(event) {
    event.preventDefault();

    const title = document.getElementById("upload-title").value.trim();
    const type = document.getElementById("upload-type").value;
    const description = document.getElementById("upload-description").value.trim();
    const fileInput = document.getElementById("upload-file");
    const file = fileInput.files[0];
    const uploadBtn = document.getElementById("upload-btn");

    if (!title || !type || !description) {
        displayStatus("Please fill in all required fields.", 'error');
        return;
    }

    uploadBtn.disabled = true;
    uploadBtn.textContent = "Processing...";
    displayStatus("Processing upload...", 'success');


    if (file) {
        const userId = auth.currentUser?.uid || 'anonymous';
        // Unique storage path using app ID and timestamp
        const uniqueFileName = `${Date.now()}_${file.name}`;
        const storagePath = `artifacts/${appId}/public/files/teacher_announcements/${uniqueFileName}`;
        const fileRef = storageRef(storage, storagePath);

        const uploadTask = uploadBytesResumable(fileRef, file);

        uploadTask.on('state_changed', 
            (snapshot) => {
                // Observe state change events such as progress, pause, and resume
                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                uploadBtn.textContent = `Upload: ${Math.round(progress)}%`;
                displayStatus(`Uploading file: ${Math.round(progress)}% done.`, 'success');
            }, 
            (error) => {
                // Handle unsuccessful uploads
                console.error("Upload error:", error);
                displayStatus(`File upload failed: ${error.message}`, 'error');
                uploadBtn.disabled = false;
                uploadBtn.textContent = "Post to Student Portal";
            }, 
            async () => {
                // Handle successful uploads on complete
                try {
                    const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                    await saveToFirestore(title, type, description, downloadURL, uniqueFileName);
                } catch (error) {
                    console.error("Error getting URL or saving to Firestore:", error);
                    displayStatus(`Error finalizing post: ${error.message}`, 'error');
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = "Post to Student Portal";
                }
            }
        );
    } else {
        // No file attached, just save metadata
        await saveToFirestore(title, type, description, null, null);
    }
}


// STORAGE AND FIRESTORE DELETE FUNCTION
async function deletePost(docId, fileName) {
    const confirmation = window.prompt(`Type "DELETE" to confirm deletion of this post (ID: ${docId}):`);
    if (confirmation !== 'DELETE') {
        displayStatus("Deletion cancelled.", 'error');
        return;
    }

    const docRef = doc(db, `artifacts/${appId}/public/data/teacher_announcements`, docId);
    
    try {
        // 1. Delete file from Firebase Storage (if it exists)
        if (fileName) {
            const storagePath = `artifacts/${appId}/public/files/teacher_announcements/${fileName}`;
            const fileRef = storageRef(storage, storagePath);
            await deleteObject(fileRef);
            console.log("File deleted from storage:", fileName);
        }
        
        // 2. Delete document from Firestore
        await deleteDoc(docRef);
        
        displayStatus(`Post and associated file deleted successfully!`, 'success');

    } catch (error) {
        // Suppress 'file not found' error if only the document needs deleting
        if (error.code === 'storage/object-not-found' || error.code === 'storage/unknown') {
            console.warn("Storage object not found or unknown error, continuing with Firestore deletion.");
            try {
                 await deleteDoc(docRef);
                 displayStatus(`Post deleted successfully (File was missing or already removed).`, 'success');
            } catch (firestoreError) {
                console.error("Error deleting document:", firestoreError);
                displayStatus(`Error deleting post: ${firestoreError.message}`, 'error');
            }
        } else {
            console.error("Error during deletion:", error);
            displayStatus(`Error deleting post: ${error.message}`, 'error');
        }
    }
}

// FIRESTORE LISTENER
function loadPastPosts() {
    const pastPostsList = document.getElementById("past-posts-list");
    // Use an onSnapshot listener for real-time updates
    const q = query(
        collection(db, `artifacts/${appId}/public/data/teacher_announcements`),
        orderBy("timestamp", "desc")
    );

    onSnapshot(q, (snapshot) => {
        pastPostsList.innerHTML = ''; // Clear existing list

        if (snapshot.empty) {
            pastPostsList.innerHTML = `<p style="text-align: center; color: var(--dark-text);">No announcements posted yet.</p>`;
            return;
        }

        snapshot.forEach((doc) => {
            const post = doc.data();
            const docId = doc.id;
            const listItem = document.createElement('li');
            listItem.classList.add('post-item');

            const fileInfo = post.fileURL 
                ? `<small> (<span style="color: #28a745; font-weight: bold;">File Attached</span>: ${post.fileName || 'N/A'})</small>` 
                : '';
            
            listItem.innerHTML = `
                <div>
                    <strong>${post.title}</strong> (${post.type})
                    <small> - Posted on ${post.date}</small>
                    ${fileInfo}
                </div>
                <button class="post-delete-btn" data-id="${docId}" data-filename="${post.fileName || ''}">Delete</button>
            `;
            
            pastPostsList.appendChild(listItem);
        });

        // Add event listeners to all new delete buttons
        pastPostsList.querySelectorAll('.post-delete-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const docId = e.target.getAttribute('data-id');
                const fileName = e.target.getAttribute('data-filename');
                deletePost(docId, fileName);
            });
        });

    }, (error) => {
        pastPostsList.innerHTML = `<p class="status-error">Error fetching posts: ${error.message}</p>`;
        console.error("Error fetching posts:", error);
    });
}


// --- Event Listeners and Initialization ---
document.addEventListener("DOMContentLoaded", () => {
    // 1. Initialize Firebase and sign in
    initializeFirebase();

    // 2. Attach upload handler
    document
        .getElementById("upload-form")
        .addEventListener("submit", handleUpload);
});
